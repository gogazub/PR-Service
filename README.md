# PR Reviewer Assignment Service

Сервис для автоматического назначения ревьюверов на pull request’ы внутри команды.  
Проект реализован как тестовое задание и демонстрирует подходы к построению микросервиса с простой доменной логикой, HTTP API и работой с PostgreSQL.

---

## 1. Что за проект

Сервис решает задачу:

- хранение команд и пользователей;
- создание pull request’ов;
- автоматический выбор до двух ревьюверов из команды автора;
- переназначение ревьюверов по доменным правилам;
- просмотр PR’ов, в которых пользователь выступает ревьювером.

Вся внешняя контрактная часть описана в OpenAPI-спецификации (`openapi.yaml`).

---

## 2. Стек и архитектура

**Язык и рантайм**

- Go (стандартная библиотека `net/http`, `database/sql`, `context`, `encoding/json`).

**Хранение данных**

- PostgreSQL
  - отдельные таблицы `teams`, `users`, `pull_requests`, `pr_reviewers`;
  - тип `pull_request_status` как `ENUM`;
  - триггеры для автоматического обновления `updated_at`.

**Инфраструктура**

- Docker + Docker Compose — запуск приложения и базы командой `make up`;
- Makefile — удобные команды сборки, запуска и тестирования.

**Логирование и качество кода**

- `zap` — структурированное логирование;
- `golangci-lint` — проверка стиля и типичных ошибок.

**Архитектура**

- Принципы “чистой архитектуры”:
  - `internal/domain` — доменные сущности (`User`, `Team`, `PullRequest`). И интерфейсы работы с бд;
  - `internal/usecase` — бизнес-логика (сервисы / application layer);
  - `internal/adapters/http` — HTTP-слой (DTO, хендлеры);
  - `internal/adapters/repo` — работа с PostgreSQL (repository layer).

---

## 3. Конфигурация и запуск

### 3.1. Конфигурация

- В репозитории есть файл `.env.example` — на его основе нужно создать `.env` с нужными параметрами:
  - строки подключения к PostgreSQL;
  - порт HTTP-сервера;

### 3.2. Makefile и основные команды

Проект управляется через `make` и `docker compose`. Основные команды:

- `make build` — сборка Docker-образа приложения;
- `make up` — поднять все сервисы в фоне (`app + postgres`);
- `make down` — остановить все сервисы;
- `make logs` — просмотр логов сервиса (`docker compose logs -f`);
- `make clean` — остановить сервисы и удалить volume’ы;
- `make test` — запуск тестов: `go test ./tests/...`; (`make up + test`)
- `make restart` — перезапустить сервисы;
- `make ps` — список запущенных контейнеров;
- `make rebuild` — `down + build + up` за один шаг.

Типичный сценарий запуска:

1. Скопировать `.env.example` → `.env` и заполнить значения.
2. `make up`
 
---

## 4. HTTP-ендпоинты

Полное описание входных/выходных данных, форматов ошибок и примеров запросов/ответов см. в файле OpenAPI-спецификации (`openapi.yaml` / `openapi.yml`). Ниже — краткий обзор доступных ручек.

### Health
- `GET /health` - проверка работы сервера

### Teams

- `POST /team/add`  
  Создаёт новую команду и её участников.  
  - Если команда с таким `team_name` уже существует — возвращается ошибка `TEAM_EXISTS` (`400`).
  - При создании команды также создаются/обновляются пользователи, привязанные к этой команде.

- `GET /team/get?team_name=...`  
  Возвращает команду с участниками по её имени (`team_name`).  
  - При успехе — объект `Team`.  
  - Если команда не найдена — ошибка с кодом `NOT_FOUND` (`404`).

### Users

- `POST /users/setIsActive`  
  Устанавливает флаг активности пользователя (`is_active`).  
  - Тело запроса: `user_id`, `is_active`.  
  - При успехе — возвращает обновлённого пользователя (`User`).  
  - Если пользователь не найден — ошибка `NOT_FOUND` (`404`).

- `GET /users/getReview?user_id=...`  
  Возвращает список PR’ов, в которых пользователь назначен ревьювером.  
  - При успехе — объект с `user_id` и массивом `pull_requests` (короткие описания `PullRequestShort`).  

### Pull Requests

- `POST /pullRequest/create`  
  Создаёт новый PR и пытается автоматически назначить до двух ревьюверов из команды автора.  
  - Тело запроса: `pull_request_id`, `pull_request_name`, `author_id`.  
  - При успехе — объект `PullRequest` с полем `assigned_reviewers`.  
  - Если PR с таким id уже существует — `PR_EXISTS` (`409`).  
  - Если автор или его команда не найдены — `NOT_FOUND` (`404`).

- `POST /pullRequest/merge`  
  Помечает PR как `MERGED` (идемпотентная операция).  
  - Тело запроса: `pull_request_id`.  
  - При успехе — обновлённый `PullRequest` с полем `mergedAt`.  
  - Если PR не найден — `NOT_FOUND` (`404`).

- `POST /pullRequest/reassign`  
  Переназначает конкретного ревьювера на другого активного участника команды автора.  
  - Тело запроса: `pull_request_id`, `old_user_id`.  
  - При успехе — объект с:
    - `pr` — обновлённый `PullRequest`,
    - `replaced_by` — `user_id` нового ревьювера.
  - Возможные доменные ошибки (`409`):
    - `PR_MERGED` — нельзя переназначать ревьюверов у `MERGED` PR.
    - `NOT_ASSIGNED` — указанный пользователь не был ревьювером этого PR.
    - `NO_CANDIDATE` — нет подходящего активного кандидата в команде.
  - Если PR или пользователь не найден — `NOT_FOUND` (`404`).

---

## 5. TODO и возможные улучшения

В рамках тестового задания реализован основной функционал сервиса. Ниже — список идей, которые планировались, но не были доведены до конца из-за ограничений по времени:

1. **Нагрузочное тестирование (k6)**  
   - Подготовить отдельный набор скриптов k6
   - Подключить запуск нагрузочных тестов отдельной make-командой.

2. **Интеграционные тесты HTTP-API** (Выполнено)
   - Поднять тестовый стенд через `docker-compose` (PostgreSQL + сервис).  
   - Написать интеграционные тесты, проверяющие:
     - корректные ответы на валидные запросы;
     - доменные ошибки (`TEAM_EXISTS`, `PR_EXISTS`, `PR_MERGED`, `NO_CANDIDATE`, `NOT_ASSIGNED`, `NOT_FOUND`);
     - идемпотентность `merge` и корректную работу `reassign`.
   - Использовать `net/http/httptest` и отдельную тестовую БД/схему.

3. **Unit-тесты бизнес-логики (usecase слой)**  
   - Покрыть тестами разные сценарии
   - Использовать `testify` (`require/assert`) и mock-реализации репозиториев (генерация через `mockgen` или ручная).

4. **Дополнительные проверки и валидация**  

5. **Observability**  
   - Добавить метрики Prometheus (latency по эндпоинтам, количество ошибок по кодам, количество успешных операций per endpoint).  

6. **Улучшение транзакционности**   (Выполнено)
   - Создать на service layer TxGenerator. Создавать транзакции для БД на верхнем уровне в функциях, многократно вызывающие БД. Например, Create Team